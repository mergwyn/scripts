#!/bin/bash

set -o nounset
#set -o errexit
XMLTV=/srv/media/xmltv
curl=/opt/puppetlabs/puppet/bin/curl
ROUTES=/etc/openvpn/client/iptv.routes
DATA="$(dirname $0)/iptv_urls"
if [[ -f ${DATA} ]]
then
  . ${DATA}
else
  echo "URL file ${DATA} not found" >&2
  exit 1
fi
URL="${MAGIC_M3U}"

TMPFILE1=$(mktemp --suffix .partial)
TMPFILE2=$(mktemp --suffix .complete)
function finish { rm -rf "${TMPFILE1}" "${TMPFILE2}"; }
trap finish EXIT

${curl} -s "${URL}" |
  egrep '^http:' | 
  egrep -v '/series/|/movie/' |
  sed 's/\r//' |
  while read CHANNEL
  do
    echo ${CHANNEL} | sed -n 's;^http://\(.*\):.*$;\1;p' 
    ${curl} -v -s "${CHANNEL}" -o /dev/null  --max-time 5 2>&1 |
      sed -n -e 's;.*Location: http://\(.*\):.*$;\1;p' 
  done |
    sed -e 's/^/route /p' |
    sort -u >> ${TMPFILE1}

if [ -s ${TMPFILE1} ]
then
  {
    echo route-nopull 
    cat ${TMPFILE1}
  } > ${TMPFILE2}
  # Restart clients if changed
  if ! diff ${ROUTES} ${TMPFILE2}
  then
    cp ${TMPFILE2} ${ROUTES}
    #openpyn uk -d -o "$(cat ${ROUTES} | sed 's/^/--/' | tr '\n' ' ')"
    systemctl restart openvpn-client@nordvpn
    sleep 10
    systemctl status openvpn-client@nordvpn
  fi
fi

# vim: nu sw=2 ai
